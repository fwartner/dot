name: Release Go Binary ðŸš€

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  release:
    name: Release Tool ðŸ› ï¸
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code ðŸ“¥
        uses: actions/checkout@v4

      - name: Set up Go Environment ðŸ¹
        uses: actions/setup-go@v4
        with:
          go-version: 1.23

      - name: Build Binaries ðŸ”¨
        run: |
          mkdir -p build
          for GOOS in linux darwin; do
            for GOARCH in amd64 arm64; do
              OUTPUT="build/dot-${GOOS}-${GOARCH}"
              GOOS=$GOOS GOARCH=$GOARCH go build -o $OUTPUT
            done
          done

      - name: Generate Release Notes ðŸ“
        id: release_notes
        run: |
          echo "## What's New ðŸŽ‰" > release_notes.md
          echo "" >> release_notes.md
          git log --pretty=format:"- %s (%h)" $(git describe --tags --abbrev=0)..HEAD >> release_notes.md
          echo "" >> release_notes.md
          echo "ðŸš€ Thank you for using dot! Stay awesome! ðŸŒŸ" >> release_notes.md

      - name: Update Release Notes and Publish Binaries ðŸŽ
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/dot-linux-amd64
            build/dot-linux-arm64
            build/dot-darwin-amd64
            build/dot-darwin-arm64
          body_path: ./release_notes.md
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  homebrew:
    name: Bump Homebrew formula
    runs-on: ubuntu-latest
    steps:
        - name: Extract version
          id: extract-version
          run: |
            echo "tag-name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        - uses: mislav/bump-homebrew-formula-action@v3
          if: "!contains(github.ref, '-')"
          with:
            formula-name: dot
            formula-path: Formula/dot.rb
            homebrew-tap: fwartner/homebrew-tap
            base-branch: main
            commit-message: |
              {{formulaName}} {{version}}
          env:
            COMMITTER_TOKEN: ${{ secrets.COMMITTER_TOKEN }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
